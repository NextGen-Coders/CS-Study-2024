# 쿠키 & 세션

<br>

## 📌 목차
1. 쿠키의 등장 
2. 쿠키 개념
3. 쿠키 동작 방식
4. 쿠키 구성 요소
5. 쿠키 종류
6. 쿠키 단점 
7. 세션 개념
8. 세션 동작 방식
9. 세션 장단점 
10. 쿠키, 세션 차이점

<br>

## ⬆ 쿠키의 등장

쿠키의 등장은 **HTTP의 특징**과 관련이 있다. 

우선 HTTP의 특징을 보자. 

### 🌐 HTTP 특징

- `Connectionless`
    - 클라이언트가 request를 서버에 보내고, 서버가 클라이언트에 요청에 맞는 response를 보내면 바로 연결을 끊는다.
- `Stateless`
    - 연결을 끊는 순간 클라이언트와 서버의 통신은 끝나며 상태 정보를 유지하지 않는다.
    - 하지만 실제로는 데이터 유지가 필요한 경우가 많다.

#### HTTP 특징 장단점
- **장점**
    - stateless, connectionless 특징 덕분에 서버 디자인이 간단하다.
    - 각각의 HTTP 요청에 대해 독립적으로 응답만 보내주면 괜찮다.

- **단점**
    - 이전 통신에 대한 정보를 저장하지 않기 때문에 매번 인증을 해줘야 한다.
    - 정보를 유지하는 Stateful한 성격의 서비스가 점점 많아졌지만 statelss이기 때문에 클라이언트의 정보를 유지하고 기억할 수 없다.

<br>

![image](https://blog.kakaocdn.net/dn/ytDys/btrHOki9cly/hSCLEhZLVBLBolegsP9EZ1/img.png)

![image](https://velog.velcdn.com/images%2Fsyleemk%2Fpost%2F1e594652-46d8-4fde-96a9-3746fface618%2Fimage.png)

### 💊 쿠키와 세션의 필요성
- HTTP 프로토콜은 위와 같은 특징으로 모든 요청 간 의존관계가 없다.

- **즉, 현재 접속한 사용자가 이전에 접속했던 사용자와 같은 사용자인지 아닌지 알 수 있는 방법이 없어 누구인지 매번 확인해야 한다.**

- 홈페이지에서 로그인을 하고, 새로 고침을 하면 로그인이 풀린 상태가 된다.

- 계속해서 연결을 유지하지 않기 때문에 리소스 낭비가 줄어드는 것이 큰 장점이다.

- **하지만, 통신할 때마다 새로 연결하기 때문에 클라이언트는 매 요청마다 인증을 해야 한다는 단점이 있다.**

- 이전 요청과 현재 요청이 같은 사용자의 요청인지 알기 위해서는 상태를 유지해야 한다.

- 이는 사용자의 접근성이 매우 떨어지는 요인이 된다.

- HTTP 프로토콜에서 상태를 유지하기 위한 기술로 쿠키와 세션이 있다.

- **쿠키와 세션은 위의 두 가지 특징을 해결하기 위해 사용된다.**

<br>

## 🍪 쿠키 개념
- 쿠키는 사용자가 어떠한 웹사이트를 방문할 경우 서버에 의해 웹 브라우저를 통해 사용자의 `컴퓨터에 설치되는 작은 기록 정보 파일`을 의미한다.

- 클라이언트 로컬에 저장되는 파일로 `클라이언트 측 (브라우저)에서 관리`한다.

- 브라우저는 쿠키를 저장해 놓았다가, 동일한 서버에 재 요청 시 저장된 데이터를 함께 전송한다.

- 사용자 인증이 유효한 시간을 명시할 수 있으며, 유효 시간이 정해지면 브라우저가 종료되어도 인증이 유지된다.

- 하지만 사용자의 정보가 컴퓨터에 고스란히 남기 때문에 `보안에 취약`하다

- 쿠키는 Key-Value 형식을 저장된다.

- 클라이언트에 총 300개의 쿠키를 저장할 수 있다.

- 하나의 도메인 당 20개의 쿠키를 가질 수 있다.

- 하나의 쿠키는 4KB(=4096byte)까지 저장 가능하다.
  

>- `저장 위치`: 클라이언트(=접속자 PC)
>- `저장 형식`: text
>- `만료 시점`: 쿠키 저장시 설정(브라우저가 종료되도, 만료시점이 지나지 않으면> 삭제되지 않음)
>- `사용하는 자원(리소스)`: 클라이언트 리소스
>- `속도`: 세션보다 빠름
>- `보안`: 세션보다 안좋음

### 쿠키의 목적
- 쿠키는 주로 세 가지 목적을 위해 사용된다.
    - `세션관리`
        - 서버에 저장해야 할 로그인, 장바구니, 게임 스코어 등의 정보 관리
    - `개인화`
        - 사용자 선호, 테마 등의 세팅
    - `트래킹`
        - 사용자 행동을 기록하고 분석하는 용도

<br>

![image](https://github.com/devSquad-study/2023-CS-Study/raw/main/Network/img/cookie_method.png)

<br>

## 📲 쿠키 동작 방식
1. 사용자가 웹사이트에 접근함으로써, 클라이언트가 페이지를 요청한다.

2. 서버에서 상태를 유지하고 싶은 값을 쿠키(cookie)로 생성

3. 서버가 응답할 때 HTTP 헤더(Set-Cookie)에 쿠키를 포함해서 전송 
    ```
    Set−Cookie: id=doy
    ```
    
4. 전달 받은 쿠키는 웹 브라우저에서 관리하다고 클라이언트에 저장한다. <br> 브라우저가 종료되어도 쿠키 만료 기간이 있다면 클라이언트에서 보관하고 있는다. 

5. 다시 서버에 요청할 때 쿠키가 존재하면 HTTP 헤더에 쿠키를 함께 보내서 요청한다. 
    ```
    cookie: id=doy
    ```

6. 서버에서는 쿠키 정보를 읽어해당 요청의 클라이언트가 누군지 식별하고 이전 상태 정보를 확인한다.

7. 확인 후 정보를 변경 할 필요가 있을 경우, 쿠키를 업데이트 하여 변경된 쿠키를 HTTP 헤더에 포함시켜 응답한다. 

<br>

![image](https://images.velog.io/images/shininghyunho/post/997e3fa9-5dbf-4fca-87a7-497c5c327101/image.png)

<br>

## ⚙ 쿠키 구성 요소
### **Name**

- 쿠키의 이름
- 각각의 쿠키를 구별하는데 사용되는 이름

### **Value**

- 쿠키에 저장된 값

### **Expires**

- 쿠키의 만료시간
- 쿠키가 언제 삭제되는지 결정
- ex) `expires="Wdy, DD−Mon−YYYY HH:MM:SS GMT"`
    - 쿠키에 만료일이 포함되어 있으면 영구적 쿠키로 간주
    - `Max-Age`를 통해 지정된 만료일이 되면 디스크에서 쿠키가 제거

### **Domain**

- 쿠키를 전송할 도메인 이름
- 쿠키가 사용되는 도메인을 지정
- ex) `domain=nesoy.github.io`
    - 이 값이 현재 탐색 중인 도메인과 일치하지 않을 경우, “타사 쿠키”로 간주되며 브라우저에서 거부
    - 이렇게 하여 한 도메인에서 다른 도메인에 대한 쿠키를 사용하지 못하게 설정

### **Path**

- 쿠키를 전송할 경로를 결정
- ex) `path=/`
    - 도메인의 루트 경로로 이동할 경우 쿠키가 전송

### **Secure**

- 보안 연결 설정 여부

### **HttpOnly**

- Http외에 다른 통신 사용 가능 설정

<br>

## 🍪🍪 쿠키 종류

|**쿠키 이름**|**특징**|
|:--:|:--:|
|session cookie |보통 만료시간 설정하고 메모리에만 저장되며 브라우저 종료시 쿠키를 삭제.|
|persistent cookie|장기간 유지되는 쿠키(예를 들어 Max-Age 1년), 파일로 저장되어 브라우저 종료와 관계없이 사용.|
|secure cookie|HTTPS에서만 사용, 쿠키 정보가 암호화 되어 전송.|
|third party cookie|방문한 도메인과 다른 도메인의 쿠키 보통 광고 베너 등을 관리할 때 유입 경로를 추적하기 위해 사용.|

<br>

## 👎 쿠키 단점
- `보안에 취약하다.`
    - 요청 시 쿠키 값을 그대로 보낸다.
    - 쿠키의 값이 브라우저에서 확인할 수 있어, 유출 및 조작 당할 위험이 존재한다.

- `허용 용량이 작다.`
    - 4096bytes 이하.
    - 쿠키에는 용량 제한이 있어 많은 정보를 담을 수 없다. 

- `웹 브라우저 마다 지원 형태가 다르다.`
    - 브라우저 간 공유가 불가능하다. 

- `한번에 하나의 정보만 저장 할 수 있다.`

- `문자열 그대로 통신하여 위변조가 가능하다.`

- `네트워크 부하 심해진다.`
    - 쿠키 정보를 매번 header에 추가해서 보낸다. 
    - 따라서 쿠키의 사이즈가 커질수록 상당한 트래픽 발생 시킨다.

<br>

## 🍩 세션 개념
쿠키의 가장 큰 단점의 사용자의 정보가 그대로 노출이 된다는 점이다.

또한 쿠키의 트래픽 문제와 쿠키를 변경하는 보안적 이슈도 있다. 

`이러한 점을 해결하기위해 세션이 등장한다.`

- 일정 시간동안 같은 사용자로부터 들어오는 일련의 요구를 하나의 상태로 보고, 그 상태를 유지시키는 기술이다. 

- 즉, 웹 브라우저를 통해 서버에 접속한 이후부터 브라우저를 종료할 때까지 유지되는 상태이다.

- 방문자가 웹 서버에 `접속해 있는 상태를 하나의 단위로 보고 그것을 세션`이라 한다.

- 쿠키와 달리 `웹 서버에 웹 컨테이너의 상태를 유지하기 위한 정보를 저장`하고 관리하기 때문에 사용자 정보가 노출되지 않는다.

- 각 클라이언트에 고유 Session ID를 부여하고 상태 정보를 유지한다.

- `Session ID로 클라이언트를 구분`해 각 요구에 맞는 서비스를 제공한다.

- 클라이언트는 Session ID를 쿠키로 저장된 형태로 가지고 있다.

- 브라우저는 필요할 때 마다 해당 Session ID 값을 이용하여 서버에 저장된 데이터를 사용할 수 있다

>- `저장 위치`: 웹 서버
>- `저장 형식`: Object
>- `만료 시점`: 브라우저 종료시 삭제(기간 저장 가능)
>- `사용하는 자원(리소스)`: 웹 서버 리소스
>- `속도`: 쿠키보다 느림
>- `보안`: 쿠키보다 좋음

<br>

![image](https://velog.velcdn.com/images/chlwogur2/post/fe78b2c2-4cc4-420d-a9ae-fc6be1900a92/image.jpg)

<br>

## 📲 세션 동작 방식

1. 사용자가 웹사이트에 접근함으로써, 클라이언트가 페이지를 요청한다.

2. 서버는 접근한 클라이언트의 Request-Header 필드인 Cookie를 확인하여, 클라이언트가 해당 session-id를 보냈는지 확인한다.

3. session-id가 존재하지 않는다면 서버가 해당 웹브라우저(클라이언트)에 유일한 ID(Session ID)를 부여한다. 

4. 서버가 응답할 때 HTTP 헤더(Set-Cookie)에 Session ID를 포함해서 전송쿠키에 Session ID를 JSESSIONID 라는 이름으로 저장한다. 
    ```
    Set−Cookie: JSESSIONID=xslei13f
    ```
5. 클라이언트는 세션 ID에 대해 쿠키를 사용해서 저장하고 가지고 있는다.

6. 웹브라우저는 이후 웹브라우저를 닫기까지 서버에 다음 요청 때 부여된 Session ID가 담겨있는 쿠키를 HTTP 헤더에 넣어서 전송한다. 
    ```
    Cookie: JSESSIONID=xslei13f
    ```
7. 서버는 세션 ID를 확인하고, 해당 세션에 관련된 정보를 확인한 후 응답한다. 

8. 세션의 정보는 사용자가 브라우저를 종료하면 삭제된다.

<br>

![image](https://youhavetosleep.dev/static/165cc0dae6c870f113dcf191ea853211/9f3a0/session-1.jpg)

<br>

## 👍👎 세션 장단점
### 장점
- 브라우저를 닫거나, 서버에서 세션을 삭제했을 때만 삭제가 되므로, 쿠키보다 비교적 **보안이 좋다.**

- 쿠키를 포함한 요청이 외부에 노출되더라도 **세션 ID 자체는 유의미한 개인정보를 담고 있지 않는다.**

- 서버 용량이 허용하는 한에서 저장 데이터에 제한이 없다.

- 서버에 저장하기 때문에 매우 관리하기 편하고 효율적이다.

- 각 사용자마다 고유한 세션 ID가 발급되지 때문에, 요청이 들어올 때마다 회원 정보를 확인 할 필요 없다. 

### 단점
- 세션의 id로 해커가 서버에 접근하면 사용자의 정보에 쉽게 접근할수 있다.

- 서버에서 클라이언트의 상태를 모두 유지하고 있어야 하므로, 사용자가 많아질수록 서버 메모리를 많이 차지해 서버에 과부화 줘서 **성능 저하의 요인이 된다.**

- 서버를 확장할때 세션이 저장되어 있는 서버로만 요청이 가도록 **분산처리를 해줘야 하기 때문에 서버를 확장하기 어렵다.**

<br>

## 🤼 쿠키, 세션 차이점
| |**쿠키**|**세션**|
|:--:|:--:|:--:|
|**저장 위치**|클라이언트 PC (브라우저)|웹 서버|
|**저장 형식**|Text|Object|
|**만료 시점**|쿠키 저장시 설정 <br> 브라우저가 종료되도 만료시점이 지나지 않으면 자동 삭제되지 않음|브라우저 종료시 삭제 (기간 지정 가능 but 브라우저 종료시 무조건 삭제)|
|**리소스**|클라이언트 리소스|웹 서버 리소스|
|**용량 제한**|총 300개하나의 도메인 당 20개하나의 쿠키 당 4KB|서버가 허용하는 한 용량제한 없음|
|**속도**|클라이언트에 저장되어 서버에 요청 시 세션보다 빠름|	실제 저장된 정보가 서버에 있어 서버 처리가 필요해 쿠키보다 느림|
|**보안**|클라이언트에 저장되어 변질되거나 위조 될 수 있어 세션보다 취약함|Session ID만 저장하고 이 값으로 서버에서 처리해 쿠키보다 좋음|

<br>

## 📍 references

- [쿠키의 등장, 쿠키 개념, 쿠키 동작 방식, 세션 개념, 세션 동작 방식, 세션 장단점, 쿠키 & 세션 차이점](https://github.com/devSquad-study/2023-CS-Study/blob/main/Network/network_cookie_and_session.md)

- [쿠키의 등장, 쿠키 동작 방식, 쿠키 구성 요소, 세션 개념, 세션 동작 방식, 쿠키 & 세션 차이점](https://doooyeon.github.io/2018/09/10/cookie-and-session.html)

- [쿠키의 등장, 쿠키 개념, 쿠키 동작 방식, 쿠키 구성 요소, 세션 장단점](https://victorydntmd.tistory.com/34)

- [쿠키 개념, 쿠키 단점, 세션 개념, 세션 장단점](https://github.com/NKLCWDT/cs/blob/main/Network/Cookie%2C%20Session%2C%20JWT.md)

- [쿠키 개념, 쿠키 동작 방식, 세션 개념, 세션 동작 방식, 세션 장단점, 쿠키 & 세션 차이점](https://github.com/CS-Free-study/CS-Study/blob/main/contents/network/network.md)

- [쿠키의 등장, 쿠키 개념, 쿠키 단점, 세션 동작 방식](https://github.com/CS-Free-study/CS-Study/blob/main/contents/network/CookieSession.md)

- [쿠키의 등장, 쿠키 구성 요소, 쿠키 종류, 쿠키 단점, 세션 개념, 세션 장단점](https://nesoy.github.io/articles/2017-03/Session-Cookie)
