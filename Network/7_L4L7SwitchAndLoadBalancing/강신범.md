# L4 스위치 vs L7 스위치

## 📋 개요

- **알아야 하는 이유**
- **로드 밸런싱**
- **L4 스위치**
- **L7 스위치**
- **고려 사항 및 성능 지표**

<br>
<br>

## 🪢 알아야 하는 이유

현대 네트워크 환경은 폭발적인 IT기기들의 보급과 기술의 발전에 따라 **대규모 트래픽이 불특정한 시점에 발생 및 집중**되는 양상을 보일 때가 있다. (**대규모 할인 행사 또는 수강 신청기간**에는 평소보다 80% 이상 까지도 높아지는 경우)
<br>이러한 경우에 수 많은 접속자를 감당하기 위해 서비스를 제공하는 측에서는 미리 트래픽을 예측하고 대응을 해야합니다. 단순히 한 서버의 성능을 높이는 작업(스케일 업)만으로는 한계가 있기에 분산 처리를 통해 여러 서버들로 구축하는 방법(스케일 아웃)을 택하였다면 트래픽을 분산하는 기술인 로드 밸런싱이 반드시 필요하다.

<br>
<br>

## 🧶 로드 밸런싱

![loadbalence](https://github.com/kangsinbeom/goorm/assets/83047601/d45397a6-d0f7-46ab-9f3a-c0b1bb9eebdb)

### 🔺 로드 밸런싱이란?

애플리케이션 가용성을 **최적화하고 긍정적인 최종 사용자 경험을 제공하기 위해 여러 서버에 네트워크 트래피을 효율적으로 분산**하는 프로세스

로드 벨런서는 이러한 로드 밸런싱을 수행하는 장치로 **네트워크나 서버에 분산된 작업 부하를 공평하게 분배하는 장치**이다.
<br>여러 대의 서버나 네트워크 장치에 들어오는 요청을 받아 해당 요청을 처리할 서버로 전달하는 역할을 한다.
<br>주로 웹 서버, 애필리케이션 서버, 데이터베이스 서버 등과 같은 서버 그룹에 사용되며 요청이 로드 밸런서에 도착하면 다양한 알고리즘에 따라 요청을 서버로 분배한다.
<br>예를 들어, 전자 상거래 사이트는 웹 애플리케이션이 웹 서버에서 소비자에게 지연이나 다운타임 업시 데이터, 이미지, 비디오 및 가격을 제공할 수 있도록 로드 밸런싱을 사용한다.

---

### 🔺 로드 밸런싱 알고리즘

- **라운드 로빈 방식**

서버와의 연결(세션)이 오래 지속되지 않는 경우에 적합하며 **요청을 순차적으로 균등하게 분배하는 방식**이다. 각 서버에 순서대로 요청을 할당하기에, 모든 서버에 고르게 부하를 분산시킨다.
<br>단순한 방식과 균등한 부하 분산으로 가장 많이 사용되는 방식이지만 서버의 성능 차이를 고려하지 않는다는 문제점이 있다.

- **가중 라운드 로빈 방식**

서버마다 가중치를 매겨 **가중치가 높은 서버에 우선적으로 요청을 배분**하는 방식이다. 서버의 트래픽 처리 능력이 상이한 경우에 사용되는 부하 방식이다.

- **IP 해시 방식**

**클라이언트의 IP 주소를 특정 서버로 매핑하여 요청을 처리하는 방식**으로 사용자의 IP를 해싱하여 부하를 분산하기에 항상 동일한 서버로 연결되는 것을 보장한다.
<br>경로가 보장되며, 접속자 수가 많을수록 분산 및 효율이 뛰어나다.

- **최소 연결 방식**

**요청이 들어온 시점에 가장 적은 연결(세션) 상태를 보이는 서버에 우선**적으로 트래픽을 할당한다.
<br>연결(세션)이 자주 길어지거나, 서버에 분배된 트래픽이 일정하지 않은 경우에 적합하다.

- **최소 응답시간 방식**

현재 연결 상태와 응답 시간을 모두 고려하여, **가장 짧은 응답 시간을 보내는 서버로 트래픽을 할당**한다.
<br>각 서버들의 가용한 리소스와 성능, 처리 중인 데이터양 등이 상이할 경우 적합하다.

- **대역폭 방식**

서버들과의 대역폭을 고려하여 서버에 트래픽을 할당한다.

---

### 🔺 장점

- **부하 분산**: 서버 그룹에 들어오는 트래픽을 여러 서버로 균등하게 분산하여 각 서버의 부하를 분담하여 특정 서버의 과부하를 방지, 시스템 전체의 성능 향상
- **고가용성**: 여러 대의 서버를 관리하므로, 한 대의 서버에 장애가 발생하도 다른 서버로 요청을 전달 할 수 있다.
- **확장성**: 새로운 서버를 시스템에 추가하거나 기존 서버를 제거하는 경우를 자동으로 감지하고 트래픽을 분배하여 시스템의 확장성을 유지하고 유연한 운영이 가능하다.

---

### 🔺 작동 방식

1. 브라우저에 도메인(naver.com) 입력
2. 클라이언트에 설정된 메인 DNS 서버로 도메인의 IP 주소 문의
3. 메인 DNS 서버에서 요청한 도메인 주소를 관리하는 별도의 DNS 서버에 IP 주소 문의
4. 별도 관리 DNS 서버는 로드 밸런서의 IP 주소를 메인 DNS 서버에게 알려줌
5. 메인 DNS 서버는 획득한 VIP주소를 클라이언트에 전송
6. 클라이언트에서 로드 밸런서의 VIP 주소로 http 요청
7. 로드 밸런서는 별도 로드 밸런싱 방법을 통해 서버에 요청을 전송
8. 서버의 작업 결과를 받은 로드 밸런서는 전달받은 http 결과를 클라이언트에게 전송

---

### 🔺 기본 기능

- **헬스 체크**: 서버에 대한 주기적인 상태확인을 통해 **장애 여부를 판단**, 정상 동작 중인 서버로만 트래픽을 배분
- **터널링**: 데이터 스트림을 **인터넷 상에서 가상의 파이프를 통해 전달시키는 기술**로 연결된 상호 간에만 캡슐화된 패킷을 구별해 캡슐화를 해제하게 한다.
- **NAT**: **IP주소를 변환해주는 기술**로 내부에서 외부로 나가는 경우에는 **SNAT**, 외부에서 내부로 트래픽이 들어오는 경우에는 **DNAT**
- **DSR**: 서버에서 클라이언트로 되돌아가는 경우, 목적지를 클라이언트로 설정한 다음 네트워크 장비나 **로드 밸런서를 거치지 않고 바로 클라이언트를 찾아가는 방식**으로 로드 밸런서의 부하를 줄여준다.

<br>
<br>

## 🧵 L4 스위치

<img width="689" alt="스크린샷 2024-01-17 오후 9 16 54" src="https://github.com/kangsinbeom/goorm/assets/83047601/edc76c7a-19ab-4bcd-b5dc-02a3d808c6e9">

### 🔹 L4 스위치란?

**전송 계층(4계층)에서 동작하며 로드 밸런싱 역할을 하는 스위치**
<br>**IP와 Port를 활용하여 서버 부하 분산**을 하며 적합한 Virtual Server IP와 Port가 들어온다면 골고루 서버에 부하 분산을 한다. TCP / UDP의 특징을 이용하기 때문에 프로토콜을 선택하여 행동을 제어(**TCP /UDP의 Header를 분석하여 로드밸런싱에 활용하지 않음**)한다.
<br>**TCP를 사용할 경우 3-way-handshake 실시를 지원**(적극적으로 개입하는 L4 스위치도 있지만 아닌 스위치도 존재한다)하여 사용자와 서버에서 생성하는 SYN, SYN/ACK, ACK Flag Packet을 순서대로 전달한다.
<br>즉 커넥션을 언제 끊을지, 유지할지 등을 제어한다.

---

### 🔹 장 · 단점 및 사례

_장점_

- 패킷의 내용을 확인하지 않아 분산하는 속도가 빠르고 효율이 높다.
- 데이터 내용을 복호화하지 않아 안전하다.
- L7 스위치에 비해 저렴하다

<br>

_단점_

- 패킷의 내용을 확인하지 않아 섬세한 라우팅이 불가하다.
- 사용자의 IP가 수시로 바뀌는 경우, 연속적인 서비스를 제공하기 어렵다.

_사례_

- 온라인 게임, 스트리밍 서비스 등 실시간 트래픽 처리가 중요한 서비스

<br>
<br>

## 🪡 L7 스위치

<img width="688" alt="스크린샷 2024-01-17 오후 9 17 26" src="https://github.com/kangsinbeom/goorm/assets/83047601/bad78d10-8cbf-4df2-85f8-570bae3610a5">

### 🔸 L7 스위치란?

**애플리케이션 계층(7계층)에서 동작하며 L4 스위치보다 고급 로드 밸런싱과 트래픽 관리에 사용되는 스위치**
<br>IP, TCP / UDP 패킷의 포트 정보 + 페이로드(패킷의 내용물로 URL, 캐시, 쿠키 등등)까지 분석해 로드 밸런싱을 한다.
<br>애플리케이션 수준에서 보안 기능을 제공해 줄 수 있으며 대표적으로 애플리케이션 방화벽 기능을 포함하여 악성 요청을 필터링하거나 인증 및 접근 제어를 수행하여 보안을 강화한다.

---

### 🔸 장 · 단점

_장점_

- 상위 계층에서 로드를 분산하여 섬세한 라우팅이 가능하다.
- 캐싱 기능을 제공한다.
- 비정상적인 트래픽을 사전에 필터링할 수 있어 서비스 안정성이 높다.

<br>

_단점_

- L4 스위치에 비해 비싸다.
- 패킷의 내용을 복호화하기에 높은 비용을 지불한다.
- 클라이언트가 로드 밸런서와 인증서를 공유해야 하기 떄문에, 공격자가 로드 밸런서를 통해 클라리언트의 데이터에 접근할 수 있다.

_사례_

- 웹 서비스, API게이트웨이, CDN 등 애프리케이션 로드 밸런싱이 필요한 서비스

---

### 🔸 동작 방식

- **URL 스위칭 방식**: 특정 하위 URL들은 특정 서버로 처리하는 방식 ex) .../a/image는 이미지 처리 서버, .../a/video는 동영상 처리 서버

- **컨텍스트 스위칭 방식**: 클라이언트가 요청한 특정 리소스에 대해 특정 서버로 연결 ex) 이미지 파일은 확장자를 참조하여, 별도로 구성된 이미지 파일이 있는 서버나 스토리지로 직접 연결

- **쿠키 지속성**: 쿠키 정보를 바탕으로 클라이언트가 연결했던 동일한 서버에 계속 할당하는 방식 ex) X-Forwarded-For 헤더에 클라이언트 IP 주소 별도 기입

<br>
<br>

## 🧥 고려 사항 및 성능 지표

### ▫️ 고려사항

_L7 스위치만 이용하면 안되는건가?_
<br>L7 스위치는 L4 스위치에 비해서 보안적으로 뛰어나고 고급 로드 밸런싱 및 트래픽 처리를 하기에 마냥 좋을 것 같지만 비용측면에서 L4 스위치보다 비싸고 불필요한 리소스를 투자하는 현상이 일어날 수 있으므로 적절히 혼용해서 사용하는 것이 중요하다.

_로드 밸런서는 만능 장비인가?_
<br>기능이 많고 트래픽 관리에 있어서 필수적이지만 장비에 장애가 발생할 경우를 생각해 로드 밸런서 자체도 이중화 구성을 할 필요가 있다.

### ▫️ 성능 지표

- **초당 연결 수**: 최대 처리 가능한 초당 TCP 세션의 개수

- **동시 연결 수**: 동시에 최대로 세션을 유지할 수 있는 개수

- **처리용량**: UDP 프로토콜에 대한 로드 밸런싱 성능 지표로 FWLB에서 중요(단위 bps 또는 pps)

<br>
<br>

## 🔗 reference

- [로드밸런서의 개념과 특징](https://m.post.naver.com/viewer/postView.naver?volumeNo=27046347&memberNo=2521903)
- [네트워크의 부하분산, 로드밸런싱 그리도 로드밸런서](https://www.stevenjlee.net/2020/06/30/%EC%9D%B4%ED%95%B4%ED%95%98%EA%B8%B0-%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC%EC%9D%98-%EB%B6%80%ED%95%98%EB%B6%84%EC%82%B0-%EB%A1%9C%EB%93%9C%EB%B0%B8%EB%9F%B0%EC%8B%B1-load-balancing-%EA%B7%B8/)
- [L4 스위치 L7 스위치 차이, 스위치란? 로드밸런서란?](https://code-lab1.tistory.com/321)
- [L4 / L7 로드밸런싱 쉽게 이해하기](https://aws-hyoh.tistory.com/entry/L4L7-%EB%A1%9C%EB%93%9C%EB%B0%B8%EB%9F%B0%EC%8B%B1-%EC%89%BD%EA%B2%8C-%EC%9D%B4%ED%95%B4%ED%95%98%EA%B8%B0)
