# L4/L7 스위치 & 로드밸런싱

<br>

## 로드밸런싱

<br>

### 1. 개요 
---

<br>

#### 로드밸런싱이란 
    많은 사람들에 대해 모든 트래픽을 감당하기엔 1대의 서버로는 부족하다. 

    대응 방안으로 하드웨어의 성능을 올리거나(Scale-up) 여러대의 서버가 나눠서 일하도록 만드는 것(Scale-out)이 있다. 

    하드웨어 향상 비용이 더욱 비싸기도 하고, 서버가 여러대면 무중단 서비스를 제공하는 환경 구성이 용이하므로 Scale-out이 효과적이다.

    Scale-out 방식으로 여러 서버를 둔다면 해당 서비스에 접근하기 위해서는 서버마다 다른 IP가 필요하다.

    서버마다 다른 공인 IP를 부여한다면 사용자들마다 각각 다른 IP로 접속할 것이고, 운영자가 원하는대로 딱 떨어지게 부하를 분산하기 어렵다.

- 이때 여러 서버에게 균등하게 대규모의 네트워크 트래픽을 분산 처리 시켜주는 것이 바로 **로드밸런싱**이다.

- 둘 이상의 CPU or 저장장치와 같은 컴퓨터 자원들에게 작업을 나누는 것이다. 

- 로드밸런싱은 분산식 웹 서비스로, 여러 서버에 부하(Load)를 분산해주는 역할을 한다. 

- 로드밸런싱 기술을 제공하는 서비스 또는 장치를 로드밸런서(Load Balancer)라고 부른다. 

- 로드밸런서를 클라이언트와 서버 사이에 두고, 부하가 일어나지 않도록 여러 서버에 분산시켜주는 방식이다. 

#### 로드밸런서란

- 로드밸런서는 **서비스용 주소 (virtual IP)** 를 가진 가상서버로 동작한다.

- 클라이언트와 다중화된 각각의 실제 서버를 중계하는 역할 수행하는 장치다.

- 각각의 서버 url을 바꿔가며 클라이언트가 직접 서버 상태를 보고 요청하는것이 아닌 로드밸런서에 클라이언트 요청을 전달한다. 

- 요청 받은 로드밸런서는 다양한 알고리즘에 따라 하위 네트워크의 서버로 요청을 전달한다.

- 이를 통해 각 서버의 부하를 분산시켜 전체 시스템의 성능과 가용성을 향상할 수 있다.

- 서비스를 운영하는 사이트의 규모에 따라 웹 서버를 추가로 증설하면서 로드밸런서로 관리해주면 웹 서버의 부하를 해결할 수 있다.

    > virtual IP란?
    >
    >>virtual IP란 로드밸런싱의 대상이 되는 여러 서버를 대표하는 가상의 IP다. 
    >>
    >>클라이언트들은 서버의 IP로 직접 요청을 하는 것이 아니라 로드밸런서가 가지고 있는 virtual IP를 대상으로 요청한다. 
    >>
    >>그리고 로드밸런서는 설정된 부하 분산 방법에 따라 각 서버로 요청을 분산시킨다.

<br>

#### 로드밸런싱 목적
- 서버 자원 사용의 최적화
- 데이터 처리량의 증가
- 클라이언트와 서버 간 응답속도 감소
- 특정 서버의 과부화 방지
- 안정성, 가용성 극대화

#### 로드밸런서 장점
1. 부하 분산: 
      - 로드밸런서는 서버 그룹에 들어오는 트래픽을 여러 서버로 균등하게 분산하여 각 서버의 부하를 분담한다. 

      - 이를 통해 특정 서버의 과부하를 방지하고 시스템 전체의 성능을 향상시킨다.

2. 고가용성: 
   - 로드밸런서는 여러 대의 서버를 관리하므로, 한 대의 서버에 장애가 발생해도 다른 서버로 요청을 전달할 수 있다. 

   - 이를 통해 시스템의 가용성을 높일 수 있다.

3. 확장성: 
   - 새로운 서버를 시스템에 추가하거나 기존 서버를 제거하는 경우, 로드밸런서는 자동으로 이를 감지하고 트래픽을 새로운 서버로 분배한다. 

   - 이를 통해 시스템의 확장성을 유지하고 유연한 운영이 가능하다.

<br>

![image](https://blog.kakaocdn.net/dn/llMx6/btqKxQTfpKV/tQbWvFHMgSu4sLanPQFHUK/img.jpg)

<br>

### 2. 주요 기능
---

<br>

#### 1. 상태 확인 (Health Check)


로드 밸런서는 서버들에 대한 주기적인 상태 확인(Health Check)을 통해 서버들의 장애 여부를 판단할 수 있다. 

이로 인해, 서버에 이상이 생기면 정상적으로 동작하는 서버로 트래픽을 보내주는 Fail-over가 가능하다. 

또한 TCP/UDP 분석이 가능하기 때문에 방화벽(Firewall)의 역할도 수행할 수 있다.

<br>

- L3 체크 : ICMP를 이용해 서버의 IP 주소가 통신 가능한 상태인지 확인한다.
- L4 체크 : TCP의 3-way handshaking을 통해 각 서버의 포트 상태를 확인한다.
- L7 체크 : 애플리케이션 계층에서 체크하는 방법으로 실제 웹 페이지에 통신을 시도해 이상 유무를 파악한다.

<br>

    ICMP : 
        Internet Control Message Protocol. 
        패킷 전송에 실패했을 때 에러가 났음을 알림.
        동시에, 해결 가능한 힌트를 제공하는 메시징 프로토콜. 
        TCP/IP의 IP 계층에서 동작.

<br>

#### 2. Tunneling

터널링(Tunneling)은 데이터 스트림을 인터넷상에서 눈에 보이지 않는 통로 = 가상의 파이프를 만들어 통신할 수 있게 하는 개념이다. 

데이터를 캡슐화해서 연결된 상호 간에만 캡슐화된 패킷을 구별해 캡슐화를 해제할 수 있다.

로드 밸런서의 virtual IP 주소로 향하는 패킷이 로드 밸런싱 서버로 전달되면 로드 밸런싱 서버에서 패킷의 목적지 주소와 포트를 검사하여 스케줄링에 따라 실제 작업 서버로 전달하게 된다. 

이때 패킷을 일반적인 스트림(Stream) 방식으로 전달하는 것이 아닌 캡슐 형식으로 싸서 전달하게 된다. 

이렇게 전달되면 작업 서버에서는 감싸진 패킷을 다시 풀고 요청을 처리한다.

**연결된 상호 간에만 캡슐화된 패킷을 구별**해 캡슐화를 해제하게 한다.

<br>

#### 3. NAT (Network Address Translation)

IP 주소를 변환해주는 기능이다. 

예를 들어, 내부 네트워크에서 사용하던 사설 IP 주소를 로드 밸런서 외부의 공인 IP 주소로 변경해준다(반대로도 가능). 

이렇게 하면 부족한 공인 IP 주소를 효율적으로 사용할 수 있지만, 로드 밸런싱 관점에서는 여러 개의 호스트가 하나의 virtual IP를 통해 접속하는 것이 주 목적이다.

- SNAT (Source Network Address Translation)
    - 내부에서 외부로 트래픽이 나가는 경우, 내부 사설 IP 주소를 외부 공인 IP 주소로 변환하는 방식이다. 
    - 집에서 사용하는 공유기가 대표적인 예이다.
  
- DNAT (Destionation Network Address Translation)
    - 외부에서 내부로 트래픽이 들어오는 경우, 외부 공인 IP 주소를 내부의 사설 IP 주소로 변환하는 방식이다.

<br>

#### 4. DSR (Direct Server Routing)

서버에서 클라이언트로 되돌아가는 경우, 목적지를 클라이언트로 설정한 다음 네트워크 장비나 로드밸런서를 거치지 않고 바로 클라이언트로 찾아가는 방식이다. 

이 경우, 로드밸런서의 부하를 줄여줄 수 있는 장점이 있다.

<br>

### 3. 동작 방식
---

<br>

![image](https://user-images.githubusercontent.com/55661631/145208882-7a6e7245-012b-4df1-bad3-aca65c22ffe3.png)

1. 클라이언트가 브라우저에서 www.google.com이라고 입력하면 PC에 설정된 DNS 서버로 DNS Query를 보내고, Local DNS 서버는 www.google.com을 관리하는 DNS 서버부터 로드밸런서의 virtual IP 주소를 획득한다.
   
2. Local DNS는 획득한 virtual IP 주소를 클라이언트에게 전송한다.
   
3. 클라이언트는 획득한 DNS를 기반으로 virtual IP로 http(s) 요청을 한다.
   
4. 로드밸런서는 최적의 서비스 서버를 내부 알고리즘을 통하여 선별한 후 요청을 전송하고, 서버 작업 결과를 로드밸런서에게 전송한다.
   
5. 전달받은 결과를 로드밸런서를 통해 클라이언트에게 전송한다.

설정한 mode에 따라 다르게 동작할 수 있다. mode에 따라 어떻게 동작하는지 살펴보자.

<br>

#### 1. Bridge/Transparent Mode


- 요청
    - 사용자가 virtual IP로 요청을 전송한다.
    - 로드밸런서에서 서버로 전송 시, Destination IP를 virtual IP에서 서버 IP로 NAT 한다.
    - 동일한 Network 대역이므로, Destination MAC 주소만 변경된다.
  
- 응답
    - 서버에서 서비스 응답 시, Destination IP가 다른 대역의 IP이므로 Gateway(Router)로 전송한다.
    - 서버에서 로드밸런서를 거치면서 Source IP를 virtual IP로 NAT을 수행한다.
    - 동일한 Network 대역이므로 MAC 주소는 변경되지 않는다.

#### 2. Router Mode


- 로드밸런서를 중심으로 상/하단의 IP 대역이 서로 다르게 구성되며, 로드밸런서는 Server 대역 네트워크의 Gateway 역할을 한다.
  
- 요청
    - 사용자가 virtual IP로 요청을 전송한다.
    - 로드밸런서에서 서버로 전송 시, Destination IP를 virtual IP에서 서버 IP로 NAT 한다.
    - Network 대역이 변경되었으므로, Source와 Destination MAC 주소 모두 변경된다.
  
- 응답
    - 서버에서 서비스 응답 시, Destination IP가 다른 대역의 IP이므로 Gateway(L4)로 전송한다.
    - 로드밸런서에서 Source IP를 virtual IP로 NAT을 수행한다.

#### 3. One Arm Mode


- One-Arm Mode는 클라이언트의 IP가 Server에 전달되지 않기 때문에 Server가 실제 클라이언트의 IP를 이용해야 할 경우 부적합한 기법이다.
  
- 일반적으로 권고되지 않는 구성 방법이다.
  
- 요청
    - 사용자가 virtual IP로 요청을 전송한다.
    - 로드밸런서에서 서버로 전송 시, Destination IP를 virtual IP에서 서버 IP로 NAT 한다.
    - Destination으로 전송을 위해서 Destination MAC 주소도 변경된다.
    - 서버에서 로드밸런서로의 전송을 위해서 Source IP도 로드밸런서의 IP Pool의 IP로 NAT 한다.

- 응답
    - 서버에 서비스 응답 시, Destination은 로드밸런서에서 NAT된 IP Pool의 IP로 보낸다.
    - 로드밸런서에서 클라이언트로 응답 시, Source IP를 서버의 IP에서 virtual IP로 NAT 한다.
    - Destination IP를 IP Pool의 IP에서 클라이언트 IP로 NAT 한다.

#### 4. DSR (Direct Server Return) Mode

- 방금 위에서 소개한 기법들은 모든 Inbound, Outbound 패킷이 로드밸런서를 거치기 때문에 로드밸런서에 많은 부하가 발생한다. 

- 대부분의 서비스들의 트래픽은 보통 Inbound 보다 Outbound Packet의 양이 많다. 

- DSR은 Outbound 패킷이 로드밸런서를 거치지 않고, 클라이언트에 바로 전달하게 만들어 로드밸런서의 부하를 줄일 수 있다.

    > inbound : 서버에 들어오는 정보
    > 
    > outbound : 서버에서 나가는 정보

<br>

### 4. 알고리즘
---
    로드 밸런싱 알고리즘은 로드 밸런서가 서로 다른 클라이언트 요청 각각에 가장 적합한 서버를 결정하기 위해 따르는 규칙이다.

    로드 밸런싱 알고리즘은 크게 2가지 범주로 나뉜다.

    아래의 알고리즘은 L4 스위치에서 사용하는 방법들이다. 

#### 정적 로드 밸런싱
- 정적 로드 밸런싱 알고리즘은 고정된 규칙을 따르며 현재 서버 상태와 무관하다. 
- 다음은 정적 로드 밸런싱의 예제다.

1. **라운드 로빈 방식**
    - 입력받은 요청을 각각의 서버에 순차적으로 각 서버에 균등하게 할당하는 방식이다.
    - 클라이언트의 요청을 순서대로 분배하기 때문에 알고리즘이 단순하고 각 서버가 트래픽을 골고루 나눠서 처리한다.
    - 각 서버의 처리량이 비슷할 경우 운용한다. 
    - 여러대의 서버가 동일한 스펙을 갖고있을때 사용하기 적합하다. 
    - 서버와의 연결(세션)이 오래 지속되지 않는 경우에 활용하기 적합하다.
    - 이 방식에서는 권한 있는 이름 서버가 특수 하드웨어나 소프트웨어 대신 로드 밸런싱을 수행한다. 
    - 이름 서버가 여러 서버의 IP 주소를 순차대로 반환하는 것이다. 


2. **가중 기반 라운드 로빈 방식**
    - 각 서버별로 가중치를 설정하고 가중치가 가장 높은 서버에 트래픽을 우선 배정한다.
    - 클라이언트 입력이 100이고 서버 A, B, C의 가중치가 2, 3, 5라고 가정했을 때 각 서버에는 20, 30, 50의 입력이 Round Robin 방식으로 전달된다.
    - 주로 서버의 트래픽 처리 능력이 상이한 경우 사용되는 로드밸런싱 방식이다. 

3. **IP 해시 방식**
    - 클라이언트의 IP주소를 해싱해 특정 서버에 매핑해 특정 IP에서 전달받은 요청을 항상 매핑된 서버로 보내는 방식이다.
    - 클라이언트의 IP를 해싱(Hashing)해 부하를 분산하기 때문에 클라이언트가 항상 동일한 서버로 연결되는 것을 보장한다.
    - 경로가 보장되며, 접속자 수가 많을수록 분산 및 효율이 뛰어나다.

#### 동적 로드 밸런싱
- 동적 로드 밸런싱 알고리즘은 트래픽을 배포하기 전에 서버의 현재 상태를 검사한다.
- 다음은 동적 로드 밸런싱 알고리즘의 몇 가지 예제다.

1. **최소 연결 방법**
    - 요청이 들어온 시점에 가장 적은 연결 상태를 보이는 서버에 우선적으로 트래픽을 배분하는 방식이다. 
    - 여기서 적은 연결 상태는 가장 접속이 적은 서버가 기준이다.
    - 세션 유지시간이 길거나 서버에 분산된 트래픽이 일정하지 않은 경우에 적합하다. 
    - 이 방법에서는 모든 연결에 모든 서버에 대해 동일한 처리 능력이 필요하다고 가정한다.

2. **가중치 기반 최소 연결 방법**
    - 가중치 기반 최소 연결 알고리즘은 일부 서버가 다른 서버보다 더 많은 연결을 처리할 수 있다고 가정한다. 
    - 따라서 각 서버에 다른 가중치 또는 용량을 할당할 수 있으며 로드 밸런서는 용량별 연결이 가장 적은 서버로 새 클라이언트 요청을 전송한다.

3. **최소 응답 시간 방법**
    - 서버의 현재 연결 상태와 응답시간(Response Time)을 모두 고려하여, 가장 짧은 응답 시간을 보내는 서버로 트래픽을 할당하는 방식이다.
    - 각 서버들의 가용한 리소스와 성능, 처리중인 데이터 양 등이 상이할 경우 적합하다.
    - 로드밸런서는 이 알고리즘을 사용하여 모든 사용자에게 더 빠른 서비스를 보장한다.

4. **리소스 기반 방법**
    - 리소스 기반 방법에서 로드 밸런서는 현재 서버 부하를 분석하여 트래픽을 배포한다.
    - 에이전트라고 하는 특수 소프트웨어는 각 서버에서 실행되며 컴퓨팅 용량 및 메모리와 같은 서버 리소스의 사용량을 계산한다. 
    - 그런 다음 로드 밸런서는 해당 서버에 트래픽을 배포하기 전에 에이전트에 충분한 여유 리소스가 있는지 확인한다.

<br>

### 5. 장애 대비
---
- 갑작스러운 장애에 대비해 로드밸런서 서버는 아래와 같이 이중화를 기본으로 구성한다.

- Active 상태와 Passive 상태 이렇게 이중화한다. 

- 로드밸런서에 장애가 발생했을 시의 시나리오는 다음과 같다.

  - 이중화된 로드밸런서들은 서로 상태 확인(Health Check)을 한다.
  - active 상태 로드밸런서가 Fail 되면 passive 상태 로드밸런서가 자동으로 active 상태 로드밸런서의 역할을 한다.
  - 이때 virtual IP가 passive 상태 로드밸런서로 변경되어 요청이 passive 상태 로드밸런서로 가는 것이다.
  - passive 상태 로드밸런서는 평상시에는 대기상태로만 있다가 active 상태 로드밸런서가 Fail 되었을 경우에만 작동을 한다.
  - 이 구성을 Fail Over라 한다.

<br>

![image](https://user-images.githubusercontent.com/55661631/145209146-0468a80d-c4dc-49a2-9919-be9e88cbb6aa.png)

<br>

### 6. 성능 지표
---

#### **초당 연결 수(Connections per second)**

- 최대 처리 가능한 초당 TCP 세션 개수를 의미한다.

- 하나의 TCP 연결은 클라이언트와 서버간의 3-way handshake 동작으로 정의된다. 

- TCP 세션을 열고 닫는 작업은 L4 레벨의 기본 세션 관리의 가장 핵심적인 동작이다. 

- L4의 포워딩 엔진 부분에 가장 많은 작업량을 요구하는 작업이므로, 이 지표는 L4의 네트워크 기계나 커널의 성능에 따라 좌우된다.

#### **동시 연결 수 (Concurrent connections)**

- 동시에 유지할 수 있는 최대 세션 개수를 의미한다.

- 초당 연결 수와 다른 점은 "일시적 동작"이 아닌, "연결 유지" 이다.

- TCP 세션이 열리면 바로 닫히는 것이 아니라 사용자는 세션을 유지한다.

- 많은 세션을 관리해야되므로 메모리에 의해 결정되는 경우가 많다.

#### **처리용량(Throughput)**

- UDP 프로토콜에 대한 로드밸런싱 성능 지표다.

- FWLB(Firwall Load Balancing)에서 중요하다.

- 단위는 bps(bit per second) 또는 pps(packet per second)를 사용한다.

- L4 스위치에 병목 현상이 걸리지 않도록 방화벽 보다 높은 성능으로 선정되어야 한다.


<br>

## L4/L7 스위치

    로드밸런서는 OSI 7계층을 기준으로 어떻게 부하를 분산하는지에 따라 종류가 나뉜다.

    상위 계층으로 갈수록 섬세한 로드밸런싱이 가능하지만, 가격과 성능에 드는 비용이 증가한다.

    로드밸런싱에는 L4 로드밸런서과 L7 로드밸런서가 가장 많이 활용된다. 

    그 이유는 L4부터 포트(Port) 정보를 바탕으로 분산하는 것이 가능하기 때문이다. 

    한 대의 서버에 각각 다른 포트 번호를 부여하여 다수의 서버 프로그램을 운영하는 경우라면 최소 L4 이상을 사용해야 한다.

### L4 스위치

- L4 스위치는 Transport Layer에서 동작하는 기능을 제공하며 로드밸런싱 역할을 하는 스위치이다.
  
- 클라이언트 요청의 TCP/UDP 프로토콜 패킷 헤더(IP, PORT)를 기반으로 Source IP와 Destination IP를 변조해 다중화된 서버와 중계해주는 역할을 한다.

- IP, PORT를 기반으로 한 로드밸런싱을 수행한다.

- 클라이언트가 TCP 프로토콜로 서버에 접속하려 할 경우 목적지 서버와 연결 성립 과정(3-Way HandShake)을 거쳐 커넥션이 생성되는데 L4스위치에서도 커넥션 데이터를 생성해 관리한다.
    - 이때 연결이 일정시간동안 사용되지 않을 경우 커넥션을 삭제하는 값을 가진다.

- 애플리케이션의 트래픽 패턴을 분석해 QoS(Quality Of Service) 정책을 적용하거나, 특정 IP주소 혹은 포트로의 접근을 제어할 수 있다.

- 이러한 L4 스위치는 대규모 네트워크 환경에서 네트워크 성능을 향상하고 부하 분산을 위한 중요한 장치로 사용된다.

- 주로 Round Robin 방식 사용한다.

### L7 스위치

- L7 스위치는 L4 스위치의 기능을 포함하는 것뿐만 아니라 애플리케이션 계층(HTTP, SMTP, FTP)의 정보를 바탕으로도 분산 처리가 가능하다.

- 쉽게 말해 HTTP 헤더, 쿠키 등과 같은 사용자의 요청을 기준으로 특정 서버에 트래픽을 분산하는 것이 가능하다.

- L7 스위치는 트래픽 내용(URI, Payload, Cookie, HTTP 헤더 등)을 직접 분석할 수 있어 L4 스위치보다 정교한 로드밸런싱에 사용된다.

- L7 스위치는 고급 로드 밸런싱과 트래픽 관리에 사용되는 스위치 장비이다.

- L4 스위치에 비해 자원의 소모가 크다.

- L7 스위치의 경우 특정한 패턴을 지닌 바이러스를 감지해 네트워크를 보호할 수 있으며, DoS/DDoS와 같은 비정상적인 트래픽을 필터링할 수 있어 네트워크 보안 분야에서도 활용되고 있다.

- 사실 어플리케이션 레벨의 데이터를 다 다룬다는 것은 불가능하고 L7 스위치는 단지 패킷의 내용을 조금 더 참조하여 약간 intelligent한 결정을 내릴 수 있게 된 것 뿐이다.

<br>

- L7 스위치에는 다음과 같은 방법들이 있다.

- **URL 스위칭 방식 (URL Switching)**
    - 특정 하위 URL들은 특정 서버로 처리하는 방식이다.
    - 예를 들어, ‘.../images’ 또는 ‘.../video’와 같은 URL은 서버가 아닌 별도의 스토리지에 있는 객체 데이터로 바로 연결되도록 구성할 수 있다.

- **컨텍스트 스위칭 방식 (Context Switching)**
    - 클라이언트가 요청한 특정 리소스에 따라 특정 서버로 연결할 수 있다.
    - 예를 들어, 이미지 파일에 대해서는 확장자를 참조해 별도로 구성된 이미지 파일이 있는 서버 또는 스토리지로 직접 연결해줄 수 있다.

- **쿠키 지속성 (Persistence with Cookies)**
    - 쿠키 정보를 바탕으로 클라이언트가 연결했었던 서버에 계속 할당해주는 방식이다.

<br>
    
    L7 스위치만 사용하면 되는 거 아닌가?

    L7 스위치는 L4 스위치의 기능도 포함할 수 있다. 

    그럼 L4 스위치를 사용하지 않고 L7 스위치만 사용하면 되지 않을까?

    물론 그렇지 않다. 

    L7 스위치는 때에 따라 너무 많은 기능을 수행한다고 볼 수도 있다. 

    예를 들어 단순히 포트 정보만을 이용해서도 충분히 부하 분산이 가능하다면 굳이 L7 계층까지의 정보를 해석하며 자원을 낭비할 필요가 있을까? 

    따라서, HTTP 요청 등 L7 계층의 해석이 필요한 경우에는 L7 스위치를 사용하고, TCP/UDP 로드밸런싱이 필요하다면 L4 스위치를 사용하면 된다.

<br>

## L4/L7 스위치 공통점, 차이점

### 공통점

- 들어온 packet을 적절한 목적지로 전달(스위치) 역할 수행한다.

- 적절한 알고리즘을 통해 로드밸런서로서의 역할을 수행한다.

- 스위치 및 서버별 Health Check를 통해, 이중화 구성후 장애시 Standby 상태의 로드밸런서는 장애 스위치의 패킷을 넘겨와 active로 동작해 서버에 넘겨준다.

### 차이점

- L4는 로드밸런서에서 알고리즘을 통해 server1 또는 server2로 데이터를 전송할지 결정을 한다.

- L4는 증계된 서버와 Client간 3way handshake를 실시하여 하나의 TCP세션을 갖게 된다.

- 그 후 application 층에서 클라이언트의 요청정보(HTTP, FTP 등)를 전달받는다.

- L7 스위치는 스위치와 client 간 3way handshake를 실시하여 따로 TCP 세션을 형성, 스위치와 server서버는 또 다른 TCP 세션을 형성하고 데이터를 중계한다.

- L7 패킷 분석을 통한 바이러스 감염 패킷 필터링이 가능한다.

- L7은 L4의 서비스 단위 로드밸런싱을 극복하기 위한 포트 + 페이로드 패턴을 이용하여 패킷스위칭을 한다.

- L4는 TCP/UDP 패킷 정보를 분석하고 해당 패킷이 사용하는 서비스 종류별(HTTP, FTP 등)로 처리하기 때문에 프록시 문제가 발생 될 수 있다.

- Mega Proxy Problem이라고 L4 스위치에서 IP Hash 방식으로 부하를 분산할 경우 특정 서버에 요청이 집중되는 현상이 발생할 수 있다.


| |L4 로드밸런서|L7 로드밸런서|
|:--:|:--:|:--:|
|네트워크 계층|layer 4 = transport layer|layer 7 = application layer|
|특징|TCP/UDP 포트 정보를 바탕으로 함|TCP/UDP 포트 정보는 물론 HTTP의 URL, FTP의 파일명, 쿠키 정보등을 바탕으로 함|
|장점|1. 데이터 안을 들여다보지 않고 패킷 레벨에서만 로드 분산하기 때문에 속도가 빠르고 효율이 높음 <br><br> 2. 데이터의 내용을 복호화할 필요가 없기에 안전함 <br><br> 3. L7 로드밸런서보다 가격이 저렴함|1. 상위 계층에서 로드를 분산하기 때문에 훨씬 더 섬세한 라우팅이 가능함 <br><br> 2. 캐싱 기능을 제공함 <br><br> 3. 비정상적인 트래픽을 사전에 필터링할 수 있어 서비스 안정성이 높음|
|단점|1. 패킷의 내용을 살펴볼 수 없기 때문에 섬세한 라우팅이 불가능함 <br><br> 2. 사용자의 IP가 수시로 바뀌는 경우라면 연속적인 서비스를 제공하기 어려움|1. 패킷의 내용을 복호화해야 하기에 더 높은 비용을 지불해야 함 <br><br> 2. 클라이언트가 로드밸런서와 인증서를 공유해야하기 때문에 공격자가 로드밸런서를 통해서 클라이언트에 데이터에 접근할 보안 상의 위험성이 존재함|
---

<br>

## references

### 주요 기능
- [주요 기능1](https://github.com/alstjgg/cs-study/blob/main/네트워크/로드밸런서.md)
- [주요 기능2](https://vaert.tistory.com/189)
- [주요 기능3](https://co-no.tistory.com/22)
- [주요 기능4](https://velog.io/@corone_hi/%EB%A1%9C%EB%93%9C-%EB%B0%B8%EB%9F%B0%EC%84%9C-Load-Balancer)

### 동작 방식
- [동작 방식1](https://github.com/alstjgg/cs-study/blob/main/네트워크/로드밸런서.md)
- [동작 방식2](https://vaert.tistory.com/189)
- [동작 방식3](https://velog.io/@corone_hi/로드-밸런서-Load-Balancer)
- [동작 방식4](https://velog.io/@corone_hi/%EB%A1%9C%EB%93%9C-%EB%B0%B8%EB%9F%B0%EC%84%9C-Load-Balancer)
- [inbound, outbound1](https://computer-science-student.tistory.com/520)
- [inbound, outbound2](https://m.blog.naver.com/thislover/220909157076)

### 알고리즘
- [알고리즘1](https://github.com/devSquad-study/2023-CS-Study/blob/main/Network/network_l4_l7_switch_and_load_balancing.md)
- [알고리즘2](https://github.com/NKLCWDT/cs/blob/main/Network/%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC%20%EC%8A%A4%EC%9C%84%EC%B9%98%EC%9D%98%20%EB%A1%9C%EB%93%9C%EB%B0%B8%EB%9F%B0%EC%84%9C.md)
- [알고리즘3](https://co-no.tistory.com/22)
- [알고리즘4](https://aws.amazon.com/ko/what-is/load-balancing/)
- [알고리즘5](https://velog.io/@corone_hi/%EB%A1%9C%EB%93%9C-%EB%B0%B8%EB%9F%B0%EC%84%9C-Load-Balancer)

### 장애 대비
- [장애 대비1](https://github.com/gyoogle/tech-interview-for-developer/blob/master/Computer%20Science/Network/%EB%A1%9C%EB%93%9C%20%EB%B0%B8%EB%9F%B0%EC%8B%B1(Load%20Balancing).md)
- [장애 대비2](https://github.com/alstjgg/cs-study/blob/main/네트워크/로드밸런서.md)

### 성능 지표
- [성능 지표1](https://github.com/alstjgg/cs-study/blob/main/네트워크/로드밸런서.md)
- [성능 지표2](https://vaert.tistory.com/189)

### L4/L7 스위치
- [L4/L7 스위치1](https://github.com/devSquad-study/2023-CS-Study/blob/main/Network/network_l4_l7_switch_and_load_balancing.md)
- [L4/L7 스위치2](https://github.com/alstjgg/cs-study/blob/main/네트워크/로드밸런서.md)
- [L4/L7 스위치3](https://ngg3319.tistory.com/102)
- [L4/L7 스위치4](https://code-lab1.tistory.com/321)

### L4/L7 스위치 공통점, 차이점
- [공통점, 차이점1](https://github.com/devSquad-study/2023-CS-Study/blob/main/Network/network_l4_l7_switch_and_load_balancing.md)
- [공통점, 차이점2](https://github.com/alstjgg/cs-study/blob/main/네트워크/로드밸런서.md)
- [공통점, 차이점3](https://vaert.tistory.com/189)